package com.zrtjoa.dao.initializingDao;

import com.zrtjoa.dao.CategoryDao;
import com.zrtjoa.dao.ProfessionDao;
import com.zrtjoa.dao.StudentDao;
import com.zrtjoa.entity.Category;
import com.zrtjoa.entity.Profession;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

/**
 * copyright    <a href="http://www.qaqavr.com/">中锐</a>
 * <pre>
 *     @author      zwy
 *     @date        2018/12/22 12:19
 *     email        1092478224@qq.com
 *     desc
 * </pre>
 */
@Component
public class RedisInitializing implements InitializingBean {

    private final static Logger logger = LoggerFactory.getLogger(RedisInitializing.class);
//
//    @Autowired
//    private JedisClient jedisClient;
//
//
//    @Value("${REDIS_ITEM_PRE}")
//    private String REDIS_ITEM_PRE;
//
//    @Value("${ITEM_CACHE_EXPIRE}")
//    private Integer ITEM_CACHE_EXPIRE;


    @Autowired
    private RedisTemplate redisTemplate ;

    @Autowired
    private StudentDao studentDao ;

    @Autowired
    private CategoryDao categoryDao ;

    @Autowired
    private ProfessionDao professionDao ;

    @Override
    public void afterPropertiesSet() throws Exception {

        logger.info("..........初始化存储学生学号信息.........");

        //查询学生学号到redis
        List<String> stuNo = studentDao.queryStuNo();

        //清空redis学号缓存
        Set<String> keys = redisTemplate.keys(stuNo.get(0).substring(0,1) + "*");
        redisTemplate.delete(keys);

        //存入缓存
        stuNo.forEach(no->{
            String key = no.substring(0,10) ;
            List classifyNos = (List) redisTemplate.opsForValue().get(key);
            redisTemplate.delete(key);
            classifyNos = classifyNos==null ? new ArrayList() : classifyNos ;
            classifyNos.add(no.substring(10,12));
            List sortList = (List) classifyNos.stream().sorted(Comparator.reverseOrder()).collect(Collectors.toList());
            redisTemplate.opsForValue().set(key,sortList);
        });

        //查询类别存入到redis
        List<Category> categories = categoryDao.getcatelist();
        redisTemplate.opsForValue().set("categories",categories);

        //查询专业存入到redis
        List<Profession> professions = professionDao.getprolist(null);
        redisTemplate.opsForValue().set("professions",professions);
    }
}
